---
title: "xcode"
format: html
editor_options: 
  chunk_output_type: console
---
```{r}
library(tidyverse)
```

# Experimental designs

## Arguments

nfactors (for the experimental design)
design
1: crd, cbd, augmented, lattice, alpha
2: crd, crbd, split.plot, strp.plot, p.rep
3+: crd, crbd
factors (list)
replication
seed
zigzag (design layout: F or T) 
qrinfo

## Idea

According the nfactors the function will take the elements list (use the list name) and convert to dataframe (enframe) and use the row number to create the replications. for each replication will include the random values for sorting. Include the design. At the final include the row and column number based in the zigzag option to be used in spatial correction. merge the factor columns with the qrinfo for unique ID and reconstruct the field-book

## Function

```{r}
rep <- 4
seed <- NULL
zigzag <- T
qrprefix <- "inkaverse"

dim <- NA #c(8, 6)

nfactors  <- 2
design <-  "crd" # "rcbd"
factors  <- list("geno" = c("a1", "b2", "c3", "d4", "d4")
                 , "salt stress" = c(0, 50, 200, 200)
                 , time = c(30, 60, 90)
                 )

# CRD & RCBD

set.seed(seed)

dfactors <- factors %>% 
  purrr::map(base::unique) %>% 
  purrr::map(stats::na.omit) %>% 
  purrr::map(~gsub("[[:space:]]", ".", .)) %>% 
  purrr::set_names(gsub("[[:space:]]", "." , names(.))) %>% 
  .[1:nfactors]
  
block.factor <- if(design %in% "crbd") {"block"} else {"rep"}

name.factors <- names(dfactors)
  
nrows <- if(anyNA(dim)) {rep} else {dim[1]}

ncols <- if(anyNA(dim)) {
  
  dfactors %>% 
    lengths() %>% 
    prod()*rep/nrows
  
  } else {dim[2]}
  
fb <- dfactors %>% 
  expand.grid() %>% 
  mutate(ntreat = as.numeric(row.names(.))) %>% 
  uncount(rep, .id = {{block.factor}}) %>% 
  arrange(.data[[block.factor]], ntreat) %>% 
  {
    if(design %in% "rcbd") {
      group_by(.data = ., .data[[block.factor]]) %>% 
      mutate(.data = ., order = sample.int(n())) %>% 
      ungroup({{block.factor}}) %>%
      arrange(.data = ., .data[[block.factor]], order) %>% 
      mutate(.data = ., plots = 100*.data[[block.factor]] + order)
    } else if (design %in% "crd") {
      mutate(.data = ., order = sample.int(n())) %>%
      arrange(.data = ., order) %>% 
      mutate(plots = 100 + order)
    }
  } %>% 
  mutate(rows = rep(1:nrows,  each = nrow(.)/nrows )) %>% 
  mutate(cols = rep(1:ncols, times = nrow(.)/ncols )) %>%
  mutate(icols = (ncols - cols) + 1) %>% 
  { 
    if(isTRUE(zigzag))
      mutate(.data = .
             , cols = case_when(
               rows %% 2 == 0 ~ as.character(icols)
               , rows %% 2 == 1 ~ as.character(cols)
      )) else {.}
    } %>% 
  select(plots, {{name.factors}}, everything()) %>% 
  mutate(across(cols, as.numeric)) %>% 
  mutate(qrprefix = qrprefix) %>% 
  tidyr::unite("barcode", qrprefix, plots, {{name.factors}}, cols, rows
               , sep = "-", remove = F) %>% 
  select(!c(icols, qrprefix)) 

result <- list(
  fieldbook = fb
  , parameters = list(
    nfactors = nfactors
    , factors = factors
    , design = design
    , rep = rep 
    , zigzag = zigzag
    , dim = c(nrows, ncols)
    , seed = seed
    , factornames = name.factors
  )
)

  
fb %>% 
  arrange(rows, cols) %>%
  inti::tarpuy_plotdesign(factor = c("geno"), fill = "plots")

```

# Test function

```{r}
library(inti)
library(gsheet)

url <- paste0("https://docs.google.com/spreadsheets/d/"
             , "1grAv_2po804pPGg9nj1o5nli01IcEGvSevDruq_ssHk/edit#gid=1807254932")
# browseURL(url)

fb <- gsheet2tbl(url)
dsg <- fb %>% tarpuy_design()
dsg %>% str()
dsg %>%
   tarpuy_plotdesign()

url2 <- paste0("https://docs.google.com/spreadsheets/d/"
               , "1grAv_2po804pPGg9nj1o5nli01IcEGvSevDruq_ssHk/edit#gid=1547389271")

variables <- gsheet2tbl(url2)

ds <- dsg %>% tarpuy_varlist(variables)

gs <- url %>% googlesheets4::as_sheets_id()

ds %>% googlesheets4::write_sheet(ss = gs, sheet = "fb")


sketch <- gs %>% range_read("fb")

sketch %>% tarpuy_plotdesign(factor = "geno")
```


